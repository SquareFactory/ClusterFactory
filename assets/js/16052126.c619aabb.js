"use strict";(self.webpackChunkcluster_factory_ce_docs=self.webpackChunkcluster_factory_ce_docs||[]).push([[826],{9613:function(e,t,n){n.d(t,{Zo:function(){return p},kt:function(){return d}});var a=n(9496);function r(e,t,n){return t in e?Object.defineProperty(e,t,{value:n,enumerable:!0,configurable:!0,writable:!0}):e[t]=n,e}function o(e,t){var n=Object.keys(e);if(Object.getOwnPropertySymbols){var a=Object.getOwnPropertySymbols(e);t&&(a=a.filter((function(t){return Object.getOwnPropertyDescriptor(e,t).enumerable}))),n.push.apply(n,a)}return n}function i(e){for(var t=1;t<arguments.length;t++){var n=null!=arguments[t]?arguments[t]:{};t%2?o(Object(n),!0).forEach((function(t){r(e,t,n[t])})):Object.getOwnPropertyDescriptors?Object.defineProperties(e,Object.getOwnPropertyDescriptors(n)):o(Object(n)).forEach((function(t){Object.defineProperty(e,t,Object.getOwnPropertyDescriptor(n,t))}))}return e}function s(e,t){if(null==e)return{};var n,a,r=function(e,t){if(null==e)return{};var n,a,r={},o=Object.keys(e);for(a=0;a<o.length;a++)n=o[a],t.indexOf(n)>=0||(r[n]=e[n]);return r}(e,t);if(Object.getOwnPropertySymbols){var o=Object.getOwnPropertySymbols(e);for(a=0;a<o.length;a++)n=o[a],t.indexOf(n)>=0||Object.prototype.propertyIsEnumerable.call(e,n)&&(r[n]=e[n])}return r}var l=a.createContext({}),c=function(e){var t=a.useContext(l),n=t;return e&&(n="function"==typeof e?e(t):i(i({},t),e)),n},p=function(e){var t=c(e.components);return a.createElement(l.Provider,{value:t},e.children)},m={inlineCode:"code",wrapper:function(e){var t=e.children;return a.createElement(a.Fragment,{},t)}},u=a.forwardRef((function(e,t){var n=e.components,r=e.mdxType,o=e.originalType,l=e.parentName,p=s(e,["components","mdxType","originalType","parentName"]),u=c(n),d=r,f=u["".concat(l,".").concat(d)]||u[d]||m[d]||o;return n?a.createElement(f,i(i({ref:t},p),{},{components:n})):a.createElement(f,i({ref:t},p))}));function d(e,t){var n=arguments,r=t&&t.mdxType;if("string"==typeof e||r){var o=n.length,i=new Array(o);i[0]=u;var s={};for(var l in t)hasOwnProperty.call(t,l)&&(s[l]=t[l]);s.originalType=e,s.mdxType="string"==typeof e?e:r,i[1]=s;for(var c=2;c<o;c++)i[c]=n[c];return a.createElement.apply(null,i)}return a.createElement.apply(null,n)}u.displayName="MDXCreateElement"},8902:function(e,t,n){n.r(t),n.d(t,{assets:function(){return p},contentTitle:function(){return l},default:function(){return d},frontMatter:function(){return s},metadata:function(){return c},toc:function(){return m}});var a=n(5443),r=n(3010),o=(n(9496),n(9613)),i=["components"],s={},l="3. Core Apps Deployment",c={unversionedId:"getting-started/core-apps-deployment",id:"getting-started/core-apps-deployment",title:"3. Core Apps Deployment",description:"We will deploy:",source:"@site/docs/getting-started/03-core-apps-deployment.md",sourceDirName:"getting-started",slug:"/getting-started/core-apps-deployment",permalink:"/docs/getting-started/core-apps-deployment",draft:!1,editUrl:"https://github.com/SquareFactory/cluster-factory-ce/tree/main/web/docs/getting-started/03-core-apps-deployment.md",tags:[],version:"current",sidebarPosition:3,frontMatter:{},sidebar:"docs",previous:{title:"2. K0s Configuration",permalink:"/docs/getting-started/k0s-configuration"},next:{title:"4. Argo Apps Deployment",permalink:"/docs/getting-started/argo-apps-deployment"}},p={},m=[{value:"CoreDNS configuration",id:"coredns-configuration",level:2},{value:"Configure the cert-manager issuers",id:"configure-the-cert-manager-issuers",level:3},{value:"Configure the routes and certificates for the dashboards",id:"configure-the-routes-and-certificates-for-the-dashboards",level:2},{value:"(optional) Configure KubeVirt",id:"optional-configure-kubevirt",level:3},{value:"Deploying the core apps",id:"deploying-the-core-apps",level:2}],u={toc:m};function d(e){var t=e.components,n=(0,r.Z)(e,i);return(0,o.kt)("wrapper",(0,a.Z)({},u,n,{components:t,mdxType:"MDXLayout"}),(0,o.kt)("h1",{id:"3-core-apps-deployment"},"3. Core Apps Deployment"),(0,o.kt)("p",null,"We will deploy:"),(0,o.kt)("ul",null,(0,o.kt)("li",{parentName:"ul"},"A new CoreDNS configuration"),(0,o.kt)("li",{parentName:"ul"},"Sealed Secrets, secret management optimized for GitOps"),(0,o.kt)("li",{parentName:"ul"},"Cert-manager issuers, to generate your SSL certificates and enable, for free, TLS configuration."),(0,o.kt)("li",{parentName:"ul"},"Argo CD, to enable GitOps."),(0,o.kt)("li",{parentName:"ul"},"Multus CNI, to support multiple network interfaces"),(0,o.kt)("li",{parentName:"ul"},"KubeVirt, to deploy VM workloads")),(0,o.kt)("h2",{id:"coredns-configuration"},"CoreDNS configuration"),(0,o.kt)("p",null,"The initial configuration of CoreDNS given by k0s does not fulfil our needs. This is why we are applying a new configuration."),(0,o.kt)("p",null,"CoreDNS is exposed to the external network thanks to the ",(0,o.kt)("inlineCode",{parentName:"p"},"IngressRoute")," objects in the ",(0,o.kt)("a",{parentName:"p",href:"https://github.com/SquareFactory/cluster-factory-ce/blob/main/core.example/coredns/overlays/prod/ingress-route.yml"},(0,o.kt)("inlineCode",{parentName:"a"},"core/coredns/overlays/prod/ingress-route.yml")),"."),(0,o.kt)("p",null,"If this is an unwanted feature (because you are using an other DNS for example), feel free to remove the routes and close the ports in the Traefik extension specification inside ",(0,o.kt)("inlineCode",{parentName:"p"},"k0sctl.yaml"),"."),(0,o.kt)("p",null,"The files that you should look for are ",(0,o.kt)("a",{parentName:"p",href:"https://github.com/SquareFactory/cluster-factory-ce/blob/main/core.example/coredns/overlays/prod/configmap.yml"},(0,o.kt)("inlineCode",{parentName:"a"},"core/coredns/overlays/prod/configmap.yml"))," and ",(0,o.kt)("a",{parentName:"p",href:"https://github.com/SquareFactory/cluster-factory-ce/blob/main/core.example/coredns/overlays/prod/deployment.yml"},(0,o.kt)("inlineCode",{parentName:"a"},"core/coredns/overlays/prod/deployment.yml")),"."),(0,o.kt)("p",null,"Inside the ",(0,o.kt)("inlineCode",{parentName:"p"},"ConfigMap"),", you'll find:"),(0,o.kt)("pre",null,(0,o.kt)("code",{parentName:"pre",className:"language-yaml",metastring:'title="core/coredns/overlays/prod/configmap.yml"',title:'"core/coredns/overlays/prod/configmap.yml"'},"apiVersion: v1\nkind: ConfigMap\nmetadata:\n  name: coredns\n  namespace: kube-system\n  labels:\n    k0s.k0sproject.io/stack: coredns\ndata:\n  Corefile: |\n    .:53 {\n      errors\n      health {\n        lameduck 5s\n      }\n      ready\n      kubernetes cluster.local in-addr.arpa ip6.arpa {\n        pods insecure\n        ttl 30\n        fallthrough in-addr.arpa ip6.arpa\n      }\n      prometheus :9153\n      forward . tls://9.9.9.9\n      reload\n    }\n    example.com:53 {\n      log\n      errors\n      ready\n      hosts /etc/coredns/example.com.db\n      reload\n    }\n\n  example.com.db: |\n    192.168.0.1 gateway.example.com\n    192.168.0.2 mn1.example.com\n    192.168.0.3 xcatmn.example.com\n    192.168.0.5 cvmfs.example.com\n    192.168.0.6 nfs.example.com\n    192.168.0.7 mysql.example.com\n    192.168.0.8 ldap.example.com\n\n    192.168.0.10 slurm-cluster-example-controller-0.example.com\n    192.168.0.20 slurm-cluster-example-login-0.example.com\n    192.168.0.21 slurm-cluster-example-login-1.example.com\n    192.168.0.51 cn1.example.com\n\n    192.168.1.100 metallb-0.example.com\n    192.168.1.100 argocd.example.com\n    192.168.1.100 traefik.example.com\n    192.168.1.100 prometheus.example.com\n    192.168.1.100 grafana.example.com\n")),(0,o.kt)("p",null,"Change the zones with yours and, eventually, change the ",(0,o.kt)("inlineCode",{parentName:"p"},"forward")," field to your favorite DNS."),(0,o.kt)("p",null,"You should configure the DNS of the machines to use CoreDNS."),(0,o.kt)("pre",null,(0,o.kt)("code",{parentName:"pre",className:"language-conf",metastring:'title="resolv.conf"',title:'"resolv.conf"'},"nameserver 192.168.1.100\nsearch example.com\n")),(0,o.kt)("div",{className:"admonition admonition-note alert alert--secondary"},(0,o.kt)("div",{parentName:"div",className:"admonition-heading"},(0,o.kt)("h5",{parentName:"div"},(0,o.kt)("span",{parentName:"h5",className:"admonition-icon"},(0,o.kt)("svg",{parentName:"span",xmlns:"http://www.w3.org/2000/svg",width:"14",height:"16",viewBox:"0 0 14 16"},(0,o.kt)("path",{parentName:"svg",fillRule:"evenodd",d:"M6.3 5.69a.942.942 0 0 1-.28-.7c0-.28.09-.52.28-.7.19-.18.42-.28.7-.28.28 0 .52.09.7.28.18.19.28.42.28.7 0 .28-.09.52-.28.7a1 1 0 0 1-.7.3c-.28 0-.52-.11-.7-.3zM8 7.99c-.02-.25-.11-.48-.31-.69-.2-.19-.42-.3-.69-.31H6c-.27.02-.48.13-.69.31-.2.2-.3.44-.31.69h1v3c.02.27.11.5.31.69.2.2.42.31.69.31h1c.27 0 .48-.11.69-.31.2-.19.3-.42.31-.69H8V7.98v.01zM7 2.3c-3.14 0-5.7 2.54-5.7 5.68 0 3.14 2.56 5.7 5.7 5.7s5.7-2.55 5.7-5.7c0-3.15-2.56-5.69-5.7-5.69v.01zM7 .98c3.86 0 7 3.14 7 7s-3.14 7-7 7-7-3.12-7-7 3.14-7 7-7z"}))),"note")),(0,o.kt)("div",{parentName:"div",className:"admonition-content"},(0,o.kt)("p",{parentName:"div"},"If some files were added and removed, you must change the ",(0,o.kt)("inlineCode",{parentName:"p"},"deployment.yml"),":"),(0,o.kt)("pre",{parentName:"div"},(0,o.kt)("code",{parentName:"pre",className:"language-diff",metastring:'title="core/coredns/overlays/prod/deployment.yml > spec > template > spec > volumes"',title:'"core/coredns/overlays/prod/deployment.yml',">":!0,spec:!0,template:!0,'volumes"':!0},"        volumes:\n          - name: config-volume\n            configMap:\n              name: coredns\n              items:\n                - key: Corefile\n                  path: Corefile\n                - key: example.com.db\n                  path: example.com.db\n+               - key: ch1.example.com.db\n+                 path: ch1.example.com.db\n              defaultMode: 420\n")))),(0,o.kt)("h3",{id:"configure-the-cert-manager-issuers"},"Configure the cert-manager issuers"),(0,o.kt)("p",null,"Specify new certificate issuers in the ",(0,o.kt)("inlineCode",{parentName:"p"},"core/cert-manager")," directory."),(0,o.kt)("p",null,"If you wish to add your private certificate authority, follow the ",(0,o.kt)("a",{parentName:"p",href:"https://cert-manager.io/docs/configuration/ca/"},"official guide of cert-manager"),"."),(0,o.kt)("pre",null,(0,o.kt)("code",{parentName:"pre",className:"language-yaml",metastring:'title="private-cluster-issuer.yml"',title:'"private-cluster-issuer.yml"'},"apiVersion: cert-manager.io/v1\nkind: ClusterIssuer\nmetadata:\n  name: private-cluster-issuer\n  namespace: cert-manager\nspec:\n  ca:\n    secretName: ca-key-pair\n")),(0,o.kt)("p",null,"If you wish to use ACME HTTP-01, follow ",(0,o.kt)("a",{parentName:"p",href:"https://cert-manager.io/docs/configuration/acme/http01/"},"this guide"),". This will create an Ingress by using the ",(0,o.kt)("inlineCode",{parentName:"p"},"ingress")," field."),(0,o.kt)("pre",null,(0,o.kt)("code",{parentName:"pre",className:"language-yaml",metastring:'title="public-cluster-issuer.yml"',title:'"public-cluster-issuer.yml"'},"apiVersion: cert-manager.io/v1\nkind: ClusterIssuer\nmetadata:\n  name: public-cluster-issuer\n  namespace: cert-manager\nspec:\n  acme:\n    email: john.smith@example.com\n    server: https://acme-staging-v02.api.letsencrypt.org/directory\n    privateKeySecretRef:\n      name: public-cluster-issuer-account-key\n    solvers:\n      - http01:\n          ingress:\n            class: traefik\n")),(0,o.kt)("h2",{id:"configure-the-routes-and-certificates-for-the-dashboards"},"Configure the routes and certificates for the dashboards"),(0,o.kt)("p",null,"Argo CD and Traefik have dashboards. To change the addresses and certificates, modify the ",(0,o.kt)("inlineCode",{parentName:"p"},"ingress-route.yml")," file and ",(0,o.kt)("inlineCode",{parentName:"p"},"certificate.yml")," in the directories ",(0,o.kt)("inlineCode",{parentName:"p"},"core/argo-cd")," and ",(0,o.kt)("inlineCode",{parentName:"p"},"core/traefik"),"."),(0,o.kt)("p",null,"Make sure the addresses correspond to the ones defined in the CoreDNS (or in your private DNS)."),(0,o.kt)("pre",null,(0,o.kt)("code",{parentName:"pre",className:"language-yaml",metastring:'title="Example of ingress-route.yml for Traefik"',title:'"Example',of:!0,"ingress-route.yml":!0,for:!0,'Traefik"':!0},"apiVersion: traefik.containo.us/v1alpha1\nkind: IngressRoute\nmetadata:\n  name: traefik-dashboard-https\n  labels:\n    app.kubernetes.io/name: traefik-dashboard-https\n    app.kubernetes.io/component: ingress-route\nspec:\n  entryPoints:\n    - websecure\n  routes:\n    - match: 'Host(`traefik.example.com`)'\n      kind: Rule\n      middlewares:\n        - name: redirect-dashboard\n      services:\n        - name: api@internal\n          kind: TraefikService\n  tls:\n    secretName: traefik.example.com-secret\n---\napiVersion: traefik.containo.us/v1alpha1\nkind: IngressRoute\nmetadata:\n  name: traefik-dashboard-http\n  labels:\n    app.kubernetes.io/name: traefik-dashboard-http\n    app.kubernetes.io/component: ingress-route\nspec:\n  entryPoints:\n    - web\n  routes:\n    - match: 'Host(`traefik.example.com`)'\n      kind: Rule\n      middlewares:\n        - name: redirect-https\n      services:\n        - name: noop@internal\n          kind: TraefikService\n")),(0,o.kt)("p",null,"IngressRoute allows us to create more complex routing rules than the classic Ingress. However, Ingress can automatically generate a TLS certificate by using annotations, without the need to create a Certificate resource."),(0,o.kt)("p",null,"Example:"),(0,o.kt)("pre",null,(0,o.kt)("code",{parentName:"pre",className:"language-yaml",metastring:'title="ingress.yaml"',title:'"ingress.yaml"'},"apiVersion: networking.k8s.io/v1\nkind: Ingress\nmetadata:\n  name: grafana-ingress\n  labels:\n    app.kubernetes.io/name: grafana-ingress\n    app.kubernetes.io/component: ingress\n  annotations:\n    cert-manager.io/cluster-issuer: selfsigned-cluster-issuer\n    traefik.ingress.kubernetes.io/router.entrypoints: websecure\n    traefik.ingress.kubernetes.io/router.tls: 'true'\nspec:\n  ingressClassName: traefik\n  rules:\n    - host: grafana.example.com\n      http:\n        paths:\n          - path: /\n            pathType: Prefix\n            backend:\n              service:\n                name: grafana\n                port:\n                  number: 80\n  tls:\n    - hosts:\n        - grafana.example.com\n      secretName: grafana.example.com-secret\n")),(0,o.kt)("p",null,"Our recommendation is to use Ingress for simple routes with HTTP. Otherwise, IngressRoute is the best solution for all the cases."),(0,o.kt)("h3",{id:"optional-configure-kubevirt"},"(optional) Configure KubeVirt"),(0,o.kt)("p",null,"If you do not want to deploy KubeVirt in all zones, you can edit ",(0,o.kt)("a",{parentName:"p",href:"https://github.dev/SquareFactory/cluster-factory-ce/blob/main/core.example/kubevirt/overlays/prod/kubevirt-cr.yaml"},(0,o.kt)("inlineCode",{parentName:"a"},"core/kubevirt/overlays/prod/kubevirt-cr.yaml")),"."),(0,o.kt)("pre",null,(0,o.kt)("code",{parentName:"pre",className:"language-yaml",metastring:'title="core/kubevirt/overlays/prod/kubevirt-cr.yaml"',title:'"core/kubevirt/overlays/prod/kubevirt-cr.yaml"'},"apiVersion: kubevirt.io/v1\nkind: KubeVirt\nmetadata:\n  name: kubevirt\n  namespace: kubevirt\nspec:\n  infra:\n    nodePlacement:\n      nodeSelector:\n        node-role.kubernetes.io/control-plane: 'true' # Restrict virt-controller and virt-api pods to only run on the control-plane nodes.\n  workloads:\n    nodePlacement:\n      nodeSelector: {} # Allow the virt-handler pods to only on all nodes \n")),(0,o.kt)("h2",{id:"deploying-the-core-apps"},"Deploying the core apps"),(0,o.kt)("p",null,"Run the ",(0,o.kt)("inlineCode",{parentName:"p"},"2.deploy-core-apps.sh")," script to deploy the cluster."),(0,o.kt)("p",null,"Congratulations! You have successfully deployed a Kubernetes Cluster with the minimum requirements. We still recommend to deploy the Monitoring stack to monitor the RAM and CPU usage of the containers. Nevertheless, you can follow the ",(0,o.kt)("a",{parentName:"p",href:"/docs/guides"},"guides"),", learn the ",(0,o.kt)("a",{parentName:"p",href:"/docs/main-concepts/k0s"},"main concepts of Cluster Factory"),", or continue the ",(0,o.kt)("a",{parentName:"p",href:"./argo-apps-deployment"},"Getting Started"),"."),(0,o.kt)("div",{className:"admonition admonition-note alert alert--secondary"},(0,o.kt)("div",{parentName:"div",className:"admonition-heading"},(0,o.kt)("h5",{parentName:"div"},(0,o.kt)("span",{parentName:"h5",className:"admonition-icon"},(0,o.kt)("svg",{parentName:"span",xmlns:"http://www.w3.org/2000/svg",width:"14",height:"16",viewBox:"0 0 14 16"},(0,o.kt)("path",{parentName:"svg",fillRule:"evenodd",d:"M6.3 5.69a.942.942 0 0 1-.28-.7c0-.28.09-.52.28-.7.19-.18.42-.28.7-.28.28 0 .52.09.7.28.18.19.28.42.28.7 0 .28-.09.52-.28.7a1 1 0 0 1-.7.3c-.28 0-.52-.11-.7-.3zM8 7.99c-.02-.25-.11-.48-.31-.69-.2-.19-.42-.3-.69-.31H6c-.27.02-.48.13-.69.31-.2.2-.3.44-.31.69h1v3c.02.27.11.5.31.69.2.2.42.31.69.31h1c.27 0 .48-.11.69-.31.2-.19.3-.42.31-.69H8V7.98v.01zM7 2.3c-3.14 0-5.7 2.54-5.7 5.68 0 3.14 2.56 5.7 5.7 5.7s5.7-2.55 5.7-5.7c0-3.15-2.56-5.69-5.7-5.69v.01zM7 .98c3.86 0 7 3.14 7 7s-3.14 7-7 7-7-3.12-7-7 3.14-7 7-7z"}))),"note")),(0,o.kt)("div",{parentName:"div",className:"admonition-content"},(0,o.kt)("p",{parentName:"div"},"You may notice that the installation of Argo CD and Sealed Secrets could have been done using ",(0,o.kt)("inlineCode",{parentName:"p"},"k0sctl.yaml"),"."),(0,o.kt)("p",{parentName:"div"},"However, we found that this would cause coupling problems with ",(0,o.kt)("inlineCode",{parentName:"p"},"k0sctl")," (for example, you would have to redeploy the k0s cluster every time you need to update Argo CD, which means downtime)."),(0,o.kt)("p",{parentName:"div"},"We believe that the ",(0,o.kt)("inlineCode",{parentName:"p"},"extensions")," field in ",(0,o.kt)("inlineCode",{parentName:"p"},"k0sctl.yaml")," should only be used for network applications, or should not be used at all."))))}d.isMDXComponent=!0}}]);