"use strict";(self.webpackChunkcluster_factory_ce_docs=self.webpackChunkcluster_factory_ce_docs||[]).push([[126],{9613:function(e,t,n){n.d(t,{Zo:function(){return u},kt:function(){return m}});var a=n(9496);function r(e,t,n){return t in e?Object.defineProperty(e,t,{value:n,enumerable:!0,configurable:!0,writable:!0}):e[t]=n,e}function o(e,t){var n=Object.keys(e);if(Object.getOwnPropertySymbols){var a=Object.getOwnPropertySymbols(e);t&&(a=a.filter((function(t){return Object.getOwnPropertyDescriptor(e,t).enumerable}))),n.push.apply(n,a)}return n}function l(e){for(var t=1;t<arguments.length;t++){var n=null!=arguments[t]?arguments[t]:{};t%2?o(Object(n),!0).forEach((function(t){r(e,t,n[t])})):Object.getOwnPropertyDescriptors?Object.defineProperties(e,Object.getOwnPropertyDescriptors(n)):o(Object(n)).forEach((function(t){Object.defineProperty(e,t,Object.getOwnPropertyDescriptor(n,t))}))}return e}function s(e,t){if(null==e)return{};var n,a,r=function(e,t){if(null==e)return{};var n,a,r={},o=Object.keys(e);for(a=0;a<o.length;a++)n=o[a],t.indexOf(n)>=0||(r[n]=e[n]);return r}(e,t);if(Object.getOwnPropertySymbols){var o=Object.getOwnPropertySymbols(e);for(a=0;a<o.length;a++)n=o[a],t.indexOf(n)>=0||Object.prototype.propertyIsEnumerable.call(e,n)&&(r[n]=e[n])}return r}var i=a.createContext({}),c=function(e){var t=a.useContext(i),n=t;return e&&(n="function"==typeof e?e(t):l(l({},t),e)),n},u=function(e){var t=c(e.components);return a.createElement(i.Provider,{value:t},e.children)},p={inlineCode:"code",wrapper:function(e){var t=e.children;return a.createElement(a.Fragment,{},t)}},d=a.forwardRef((function(e,t){var n=e.components,r=e.mdxType,o=e.originalType,i=e.parentName,u=s(e,["components","mdxType","originalType","parentName"]),d=c(n),m=r,g=d["".concat(i,".").concat(m)]||d[m]||p[m]||o;return n?a.createElement(g,l(l({ref:t},u),{},{components:n})):a.createElement(g,l({ref:t},u))}));function m(e,t){var n=arguments,r=t&&t.mdxType;if("string"==typeof e||r){var o=n.length,l=new Array(o);l[0]=d;var s={};for(var i in t)hasOwnProperty.call(t,i)&&(s[i]=t[i]);s.originalType=e,s.mdxType="string"==typeof e?e:r,l[1]=s;for(var c=2;c<o;c++)l[c]=n[c];return a.createElement.apply(null,l)}return a.createElement.apply(null,n)}d.displayName="MDXCreateElement"},3420:function(e,t,n){n.d(t,{Z:function(){return l}});var a=n(9496),r=n(1626),o="tabItem_tolf";function l(e){var t=e.children,n=e.hidden,l=e.className;return a.createElement("div",{role:"tabpanel",className:(0,r.Z)(o,l),hidden:n},t)}},3536:function(e,t,n){n.d(t,{Z:function(){return m}});var a=n(2848),r=n(9496),o=n(1472),l=n(6540),s=n(7737),i=n(1539),c=n(1626),u="tabList_rsfj",p="tabItem_lCYJ";function d(e){var t,n,o,d=e.lazy,m=e.block,g=e.defaultValue,v=e.values,y=e.groupId,h=e.className,f=r.Children.map(e.children,(function(e){if((0,r.isValidElement)(e)&&void 0!==e.props.value)return e;throw new Error("Docusaurus error: Bad <Tabs> child <"+("string"==typeof e.type?e.type:e.type.name)+'>: all children of the <Tabs> component should be <TabItem>, and every <TabItem> should have a unique "value" prop.')})),k=null!=v?v:f.map((function(e){var t=e.props;return{value:t.value,label:t.label,attributes:t.attributes}})),b=(0,l.l)(k,(function(e,t){return e.value===t.value}));if(b.length>0)throw new Error('Docusaurus error: Duplicate values "'+b.map((function(e){return e.value})).join(", ")+'" found in <Tabs>. Every value needs to be unique.');var N=null===g?g:null!=(t=null!=g?g:null==(n=f.find((function(e){return e.props.default})))?void 0:n.props.value)?t:null==(o=f[0])?void 0:o.props.value;if(null!==N&&!k.some((function(e){return e.value===N})))throw new Error('Docusaurus error: The <Tabs> has a defaultValue "'+N+'" but none of its children has the corresponding value. Available values are: '+k.map((function(e){return e.value})).join(", ")+". If you intend to show no default tab, use defaultValue={null} instead.");var x=(0,s.U)(),w=x.tabGroupChoices,C=x.setTabGroupChoices,E=(0,r.useState)(N),T=E[0],I=E[1],O=[],P=(0,i.o5)().blockElementScrollPositionUntilNextRender;if(null!=y){var L=w[y];null!=L&&L!==T&&k.some((function(e){return e.value===L}))&&I(L)}var M=function(e){var t=e.currentTarget,n=O.indexOf(t),a=k[n].value;a!==T&&(P(t),I(a),null!=y&&C(y,a))},S=function(e){var t,n=null;switch(e.key){case"ArrowRight":var a=O.indexOf(e.currentTarget)+1;n=O[a]||O[0];break;case"ArrowLeft":var r=O.indexOf(e.currentTarget)-1;n=O[r]||O[O.length-1]}null==(t=n)||t.focus()};return r.createElement("div",{className:(0,c.Z)("tabs-container",u)},r.createElement("ul",{role:"tablist","aria-orientation":"horizontal",className:(0,c.Z)("tabs",{"tabs--block":m},h)},k.map((function(e){var t=e.value,n=e.label,o=e.attributes;return r.createElement("li",(0,a.Z)({role:"tab",tabIndex:T===t?0:-1,"aria-selected":T===t,key:t,ref:function(e){return O.push(e)},onKeyDown:S,onFocus:M,onClick:M},o,{className:(0,c.Z)("tabs__item",p,null==o?void 0:o.className,{"tabs__item--active":T===t})}),null!=n?n:t)}))),d?(0,r.cloneElement)(f.filter((function(e){return e.props.value===T}))[0],{className:"margin-top--md"}):r.createElement("div",{className:"margin-top--md"},f.map((function(e,t){return(0,r.cloneElement)(e,{key:t,hidden:e.props.value!==T})}))))}function m(e){var t=(0,o.Z)();return r.createElement(d,(0,a.Z)({key:String(t)},e))}},5821:function(e,t,n){n.r(t),n.d(t,{assets:function(){return d},contentTitle:function(){return u},default:function(){return v},frontMatter:function(){return c},metadata:function(){return p},toc:function(){return m}});var a=n(2848),r=n(9213),o=(n(9496),n(9613)),l=n(3536),s=n(3420),i=["components"],c={},u="How to deploy xCAT",p={unversionedId:"guides/provisioning/deploy-xcat",id:"guides/provisioning/deploy-xcat",title:"How to deploy xCAT",description:"xCAT deployment graph",source:"@site/docs/guides/02-provisioning/01-deploy-xcat.mdx",sourceDirName:"guides/02-provisioning",slug:"/guides/provisioning/deploy-xcat",permalink:"/docs/guides/provisioning/deploy-xcat",draft:!1,editUrl:"https://github.com/facebook/docusaurus/tree/main/packages/create-docusaurus/templates/shared/docs/guides/02-provisioning/01-deploy-xcat.mdx",tags:[],version:"current",sidebarPosition:1,frontMatter:{},sidebar:"docs",previous:{title:"Deploy the Kube Prometheus Stack",permalink:"/docs/guides/monitoring/deploy"},next:{title:"Build an OS Image with Packer",permalink:"/docs/guides/provisioning/packer-build"}},d={},m=[{value:"Helm and Docker resources",id:"helm-and-docker-resources",level:2},{value:"1. Deploy Namespace and AppProject",id:"1-deploy-namespace-and-appproject",level:2},{value:"2. Persistent Volumes and PVC",id:"2-persistent-volumes-and-pvc",level:2},{value:"2.a. Creating a <code>StorageClass</code> or <code>PersistentVolume</code>",id:"2a-creating-a-storageclass-or-persistentvolume",level:3},{value:"2.b. Editing the <code>xcat-app.yml</code> to select the volume",id:"2b-editing-the-xcat-appyml-to-select-the-volume",level:3},{value:"3. Editing <code>xcat-app.yml</code> values",id:"3-editing-xcat-appyml-values",level:2},{value:"3.a. Selecting a zone",id:"3a-selecting-a-zone",level:3},{value:"3.b. Network configuration",id:"3b-network-configuration",level:3},{value:"3.d. Verify the default values.",id:"3d-verify-the-default-values",level:3},{value:"4. Deploy xCAT",id:"4-deploy-xcat",level:2}],g={toc:m};function v(e){var t=e.components,c=(0,r.Z)(e,i);return(0,o.kt)("wrapper",(0,a.Z)({},g,c,{components:t,mdxType:"MDXLayout"}),(0,o.kt)("h1",{id:"how-to-deploy-xcat"},"How to deploy xCAT"),(0,o.kt)("p",null,(0,o.kt)("img",{alt:"xCAT deployment graph",src:n(9135).Z,width:"1017",height:"228"})),(0,o.kt)("h2",{id:"helm-and-docker-resources"},"Helm and Docker resources"),(0,o.kt)("p",null,"The Helm resources is stored on ",(0,o.kt)("a",{parentName:"p",href:"https://github.com/SquareFactory/cluster-factory-ce/tree/main/helm/xcat"},"Cluster Factory Git Repository"),"."),(0,o.kt)("p",null,"The Dockerfile is described in the git repository ",(0,o.kt)("a",{parentName:"p",href:"https://github.com/SquareFactory/xcat-rocky"},"SquareFactory/xcat-rocky"),"."),(0,o.kt)("p",null,"An Docker image can be pulled with:"),(0,o.kt)("pre",null,(0,o.kt)("code",{parentName:"pre",className:"language-sh"},"docker pull ghcr.io/squarefactory/xcat-rocky:latest\n")),(0,o.kt)("h2",{id:"1-deploy-namespace-and-appproject"},"1. Deploy Namespace and AppProject"),(0,o.kt)("pre",null,(0,o.kt)("code",{parentName:"pre",className:"language-shell",metastring:'title="user@local:/cluster-factory-ce"',title:'"user@local:/cluster-factory-ce"'},"kubectl apply -f argo/provisioning/\n")),(0,o.kt)("h2",{id:"2-persistent-volumes-and-pvc"},"2. Persistent Volumes and PVC"),(0,o.kt)("h3",{id:"2a-creating-a-storageclass-or-persistentvolume"},"2.a. Creating a ",(0,o.kt)("inlineCode",{parentName:"h3"},"StorageClass")," or ",(0,o.kt)("inlineCode",{parentName:"h3"},"PersistentVolume")),(0,o.kt)("p",null,"We will use NFS. Feel free to use another type of storage. We recommend at least 100 GB since the storage is used to store the root file system of the operating system images."),(0,o.kt)(l.Z,{groupId:"volume",mdxType:"Tabs"},(0,o.kt)(s.Z,{value:"storage-class",label:"StorageClass (dynamic)",default:!0,mdxType:"TabItem"},(0,o.kt)("pre",null,(0,o.kt)("code",{parentName:"pre",className:"language-yaml",metastring:'title="argo/provisioning/volumes/storage-class.yaml"',title:'"argo/provisioning/volumes/storage-class.yaml"'},"apiVersion: storage.k8s.io/v1\nkind: StorageClass\nmetadata:\n  name: xcat-nfs\n  namespace: provisioning\n  labels:\n    app: xcat\n    topology.kubernetes.io/region: <FILL ME> # <country code>-<city>\n    topology.kubernetes.io/zone: <FILL ME> # <country code>-<city>-<index>\nprovisioner: nfs.csi.k8s.io\nparameters:\n  server: <FILL ME> # IP or host\n  share: <FILL ME> # /srv/nfs/k8s/xcat\n  mountPermissions: '0775'\nmountOptions:\n  - hard\n  - nfsvers=4.1\n  - noatime\n  - nodiratime\nvolumeBindingMode: Immediate\nreclaimPolicy: Retain\nallowedTopologies:\n  - matchLabelExpressions:\n      - key: topology.kubernetes.io/zone\n        values:\n          - <FILL ME> # <country code>-<city>-<index>\n")),(0,o.kt)("pre",null,(0,o.kt)("code",{parentName:"pre",className:"language-shell",metastring:'title="user@local:/cluster-factory-ce"',title:'"user@local:/cluster-factory-ce"'},"kubectl apply -f argo/provisioning/volumes/storage-class.yaml\n"))),(0,o.kt)(s.Z,{value:"persistent-volume",label:"PersistentVolume (static)",mdxType:"TabItem"},(0,o.kt)("pre",null,(0,o.kt)("code",{parentName:"pre",className:"language-yaml",metastring:'title="argo/provisioning/volumes/persistent-volume.yaml"',title:'"argo/provisioning/volumes/persistent-volume.yaml"'},"apiVersion: v1\nkind: PersistentVolume\nmetadata:\n  name: xcat-pv\n  namespace: provisioning\n  labels:\n    app: xcat\n    topology.kubernetes.io/region: <FILL ME> # <country code>-<city>\n    topology.kubernetes.io/zone: <FILL ME> # <country code>-<city>-<index>\nspec:\n  capacity:\n    storage: 100Gi\n  mountOptions:\n    - hard\n    - nfsvers=4.1\n    - noatime\n    - nodiratime\n  csi:\n    driver: nfs.csi.k8s.io\n    readOnly: false\n    volumeHandle: <unique id> # uuidgen\n    volumeAttributes:\n      server: <FILL ME> # IP or host\n      share: <FILL ME> # /srv/nfs/k8s/xcat\n  accessModes:\n    - ReadWriteOnce\n  persistentVolumeReclaimPolicy: Retain\n")),(0,o.kt)("pre",null,(0,o.kt)("code",{parentName:"pre",className:"language-shell",metastring:'title="user@local:/cluster-factory-ce"',title:'"user@local:/cluster-factory-ce"'},"kubectl apply -f argo/provisioning/volumes/persistent-volume.yaml\n")),(0,o.kt)("p",null,"The label ",(0,o.kt)("inlineCode",{parentName:"p"},"app=xcat")," will be used by the PersistentVolumeClaim."))),(0,o.kt)("h3",{id:"2b-editing-the-xcat-appyml-to-select-the-volume"},"2.b. Editing the ",(0,o.kt)("inlineCode",{parentName:"h3"},"xcat-app.yml")," to select the volume"),(0,o.kt)(l.Z,{groupId:"volume",mdxType:"Tabs"},(0,o.kt)(s.Z,{value:"storage-class",label:"StorageClass (dynamic)",default:!0,mdxType:"TabItem"},(0,o.kt)("p",null,"Edit the values accordingly:"),(0,o.kt)("pre",null,(0,o.kt)("code",{parentName:"pre",className:"language-yaml",metastring:'title="argo/provisioning/apps/xcat-app.yml > spec > source > helm > values"',title:'"argo/provisioning/apps/xcat-app.yml',">":!0,spec:!0,source:!0,helm:!0,'values"':!0},"persistence:\n  storageClassName: 'xcat-nfs'\n  accessModes: ['ReadWriteOnce']\n  size: 50Gi\n"))),(0,o.kt)(s.Z,{value:"persistent-volume",label:"PersistentVolume (static)",mdxType:"TabItem"},(0,o.kt)("pre",null,(0,o.kt)("code",{parentName:"pre",className:"language-yaml",metastring:'title="argo/provisioning/apps/xcat-app.yml > spec > source > helm > values > persistence"',title:'"argo/provisioning/apps/xcat-app.yml',">":!0,spec:!0,source:!0,helm:!0,values:!0,'persistence"':!0},"persistence:\n  storageClassName: ''\n  accessModes: ['ReadWriteOnce']\n  size: 50Gi\n  selectorLabels:\n    app: xcat\n    topology.kubernetes.io/region: <FILL ME> # <country code>-<city>\n    topology.kubernetes.io/zone: <FILL ME> # <country code>-<city>-<index>\n")))),(0,o.kt)("h2",{id:"3-editing-xcat-appyml-values"},"3. Editing ",(0,o.kt)("inlineCode",{parentName:"h2"},"xcat-app.yml")," values"),(0,o.kt)("div",{className:"admonition admonition-tip alert alert--success"},(0,o.kt)("div",{parentName:"div",className:"admonition-heading"},(0,o.kt)("h5",{parentName:"div"},(0,o.kt)("span",{parentName:"h5",className:"admonition-icon"},(0,o.kt)("svg",{parentName:"span",xmlns:"http://www.w3.org/2000/svg",width:"12",height:"16",viewBox:"0 0 12 16"},(0,o.kt)("path",{parentName:"svg",fillRule:"evenodd",d:"M6.5 0C3.48 0 1 2.19 1 5c0 .92.55 2.25 1 3 1.34 2.25 1.78 2.78 2 4v1h5v-1c.22-1.22.66-1.75 2-4 .45-.75 1-2.08 1-3 0-2.81-2.48-5-5.5-5zm3.64 7.48c-.25.44-.47.8-.67 1.11-.86 1.41-1.25 2.06-1.45 3.23-.02.05-.02.11-.02.17H5c0-.06 0-.13-.02-.17-.2-1.17-.59-1.83-1.45-3.23-.2-.31-.42-.67-.67-1.11C2.44 6.78 2 5.65 2 5c0-2.2 2.02-4 4.5-4 1.22 0 2.36.42 3.22 1.19C10.55 2.94 11 3.94 11 5c0 .66-.44 1.78-.86 2.48zM4 14h5c-.23 1.14-1.3 2-2.5 2s-2.27-.86-2.5-2z"}))),"tip")),(0,o.kt)("div",{parentName:"div",className:"admonition-content"},(0,o.kt)("p",{parentName:"div"},"Read the ",(0,o.kt)("a",{parentName:"p",href:"https://github.com/SquareFactory/cluster-factory-ce/blob/main/helm/xcat/values.yaml"},(0,o.kt)("inlineCode",{parentName:"a"},"values.yaml"))," to see all the default values."))),(0,o.kt)("h3",{id:"3a-selecting-a-zone"},"3.a. Selecting a zone"),(0,o.kt)("p",null,"xCAT will use the host network. Make sure that xCAT stays on the same network by using the ",(0,o.kt)("inlineCode",{parentName:"p"},"nodeSelector"),"."),(0,o.kt)("p",null,"Your nodes should be annotated with ",(0,o.kt)("inlineCode",{parentName:"p"},"topology.kubernetes.io/region")," and ",(0,o.kt)("inlineCode",{parentName:"p"},"topology.kubernetes.io/zone"),"."),(0,o.kt)("pre",null,(0,o.kt)("code",{parentName:"pre",className:"language-yaml",metastring:'title="argo/provisioning/apps/xcat-app.yml > spec > source > helm > values > nodeSelector"',title:'"argo/provisioning/apps/xcat-app.yml',">":!0,spec:!0,source:!0,helm:!0,values:!0,'nodeSelector"':!0},"nodeSelector:\n  topology.kubernetes.io/region: <FILL ME> # <country code>-<city>\n  topology.kubernetes.io/zone: <FILL ME> # <country code>-<city>-<index>\n")),(0,o.kt)("h3",{id:"3b-network-configuration"},"3.b. Network configuration"),(0,o.kt)("p",null,"xCAT will be connected to the host network using the IPVLAN CNI plugin. Make sure that Multus CNI is already installed."),(0,o.kt)("div",{className:"admonition admonition-tip alert alert--success"},(0,o.kt)("div",{parentName:"div",className:"admonition-heading"},(0,o.kt)("h5",{parentName:"div"},(0,o.kt)("span",{parentName:"h5",className:"admonition-icon"},(0,o.kt)("svg",{parentName:"span",xmlns:"http://www.w3.org/2000/svg",width:"12",height:"16",viewBox:"0 0 12 16"},(0,o.kt)("path",{parentName:"svg",fillRule:"evenodd",d:"M6.5 0C3.48 0 1 2.19 1 5c0 .92.55 2.25 1 3 1.34 2.25 1.78 2.78 2 4v1h5v-1c.22-1.22.66-1.75 2-4 .45-.75 1-2.08 1-3 0-2.81-2.48-5-5.5-5zm3.64 7.48c-.25.44-.47.8-.67 1.11-.86 1.41-1.25 2.06-1.45 3.23-.02.05-.02.11-.02.17H5c0-.06 0-.13-.02-.17-.2-1.17-.59-1.83-1.45-3.23-.2-.31-.42-.67-.67-1.11C2.44 6.78 2 5.65 2 5c0-2.2 2.02-4 4.5-4 1.22 0 2.36.42 3.22 1.19C10.55 2.94 11 3.94 11 5c0 .66-.44 1.78-.86 2.48zM4 14h5c-.23 1.14-1.3 2-2.5 2s-2.27-.86-2.5-2z"}))),"tip")),(0,o.kt)("div",{parentName:"div",className:"admonition-content"},(0,o.kt)("p",{parentName:"div"},"Check with:"),(0,o.kt)("pre",{parentName:"div"},(0,o.kt)("code",{parentName:"pre",className:"language-shell"},"> kubectl get daemonset -n kube-system kube-multus-ds\nNAME             DESIRED   CURRENT   READY   UP-TO-DATE   AVAILABLE   NODE SELECTOR   AGE\nkube-multus-ds   1         1         1       1            1           <none>          28d\n")),(0,o.kt)("p",{parentName:"div"},"If it isn't already deployed, you can deploy Multus with:"),(0,o.kt)("pre",{parentName:"div"},(0,o.kt)("code",{parentName:"pre",className:"language-shell"},"kubectl apply -f https://raw.githubusercontent.com/k8snetworkplumbingwg/multus-cni/master/deployments/multus-daemonset-thick-plugin.yml\n")))),(0,o.kt)("p",null,(0,o.kt)("img",{alt:"xcat network diagram",src:n(1239).Z,width:"364",height:"377"})),(0,o.kt)("p",null,"Similar to configuring the network interface of a Virtual Machine, you must change these fields:"),(0,o.kt)("pre",null,(0,o.kt)("code",{parentName:"pre",className:"language-yaml",metastring:'title="argo/provisioning/apps/xcat-app.yml > spec > source > helm > values > net"',title:'"argo/provisioning/apps/xcat-app.yml',">":!0,spec:!0,source:!0,helm:!0,values:!0,'net"':!0},"net:\n  # Kubernetes host interface\n  masterInterface: eth0\n  mode: l2\n  type: ipvlan\n\n  # https://www.cni.dev/plugins/current/ipam/static/\n  ipam:\n    type: static\n    addresses:\n      - address: 10.10.2.2/24\n        gateway: 10.10.2.1\n    routes:\n      - dst: 0.0.0.0/0\n      - dst: 10.10.2.0/24\n        gw: 10.10.2.1\n\n  # https://kubernetes.io/docs/concepts/services-networking/dns-pod-service/#pod-dns-config\n  dns:\n    nameservers:\n      - 127.0.0.1\n")),(0,o.kt)("p",null,"Use IPAM ",(0,o.kt)("inlineCode",{parentName:"p"},"static")," since xCAT has a ISC DHCP server."),(0,o.kt)("h3",{id:"3d-verify-the-default-values"},"3.d. Verify the default values."),(0,o.kt)("p",null,"Verify the default value inside the ",(0,o.kt)("a",{parentName:"p",href:"https://github.com/SquareFactory/cluster-factory-ce/blob/main/helm/xcat/values.yaml"},"git repository"),"."),(0,o.kt)("h2",{id:"4-deploy-xcat"},"4. Deploy xCAT"),(0,o.kt)("pre",null,(0,o.kt)("code",{parentName:"pre",className:"language-shell",metastring:'title="user@local:/cluster-factory-ce"',title:'"user@local:/cluster-factory-ce"'},"kubectl apply -f argo/provisioning/apps/xcat-app.yml\n")))}v.isMDXComponent=!0},9135:function(e,t,n){t.Z=n.p+"assets/images/image-20220506142457636-1829689768a08986687e4f0518f45ce9.png"},1239:function(e,t,n){t.Z=n.p+"assets/images/xcat.drawio-af91fd77574a3fae7997ae5e4969f7e1.svg"}}]);