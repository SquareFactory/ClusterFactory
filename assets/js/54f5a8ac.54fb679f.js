"use strict";(self.webpackChunkcluster_factory_ce_docs=self.webpackChunkcluster_factory_ce_docs||[]).push([[1535],{9613:function(e,t,n){n.d(t,{Zo:function(){return u},kt:function(){return f}});var r=n(9496);function o(e,t,n){return t in e?Object.defineProperty(e,t,{value:n,enumerable:!0,configurable:!0,writable:!0}):e[t]=n,e}function a(e,t){var n=Object.keys(e);if(Object.getOwnPropertySymbols){var r=Object.getOwnPropertySymbols(e);t&&(r=r.filter((function(t){return Object.getOwnPropertyDescriptor(e,t).enumerable}))),n.push.apply(n,r)}return n}function i(e){for(var t=1;t<arguments.length;t++){var n=null!=arguments[t]?arguments[t]:{};t%2?a(Object(n),!0).forEach((function(t){o(e,t,n[t])})):Object.getOwnPropertyDescriptors?Object.defineProperties(e,Object.getOwnPropertyDescriptors(n)):a(Object(n)).forEach((function(t){Object.defineProperty(e,t,Object.getOwnPropertyDescriptor(n,t))}))}return e}function s(e,t){if(null==e)return{};var n,r,o=function(e,t){if(null==e)return{};var n,r,o={},a=Object.keys(e);for(r=0;r<a.length;r++)n=a[r],t.indexOf(n)>=0||(o[n]=e[n]);return o}(e,t);if(Object.getOwnPropertySymbols){var a=Object.getOwnPropertySymbols(e);for(r=0;r<a.length;r++)n=a[r],t.indexOf(n)>=0||Object.prototype.propertyIsEnumerable.call(e,n)&&(o[n]=e[n])}return o}var l=r.createContext({}),c=function(e){var t=r.useContext(l),n=t;return e&&(n="function"==typeof e?e(t):i(i({},t),e)),n},u=function(e){var t=c(e.components);return r.createElement(l.Provider,{value:t},e.children)},p={inlineCode:"code",wrapper:function(e){var t=e.children;return r.createElement(r.Fragment,{},t)}},d=r.forwardRef((function(e,t){var n=e.components,o=e.mdxType,a=e.originalType,l=e.parentName,u=s(e,["components","mdxType","originalType","parentName"]),d=c(n),f=o,m=d["".concat(l,".").concat(f)]||d[f]||p[f]||a;return n?r.createElement(m,i(i({ref:t},u),{},{components:n})):r.createElement(m,i({ref:t},u))}));function f(e,t){var n=arguments,o=t&&t.mdxType;if("string"==typeof e||o){var a=n.length,i=new Array(a);i[0]=d;var s={};for(var l in t)hasOwnProperty.call(t,l)&&(s[l]=t[l]);s.originalType=e,s.mdxType="string"==typeof e?e:o,i[1]=s;for(var c=2;c<a;c++)i[c]=n[c];return r.createElement.apply(null,i)}return r.createElement.apply(null,n)}d.displayName="MDXCreateElement"},3770:function(e,t,n){n.r(t),n.d(t,{assets:function(){return u},contentTitle:function(){return l},default:function(){return f},frontMatter:function(){return s},metadata:function(){return c},toc:function(){return p}});var r=n(665),o=n(151),a=(n(9496),n(9613)),i=["components"],s={},l="3. K0s Configuration",c={unversionedId:"getting-started/k0s-configuration",id:"getting-started/k0s-configuration",title:"3. K0s Configuration",description:"Specifying the hosts",source:"@site/docs/getting-started/03-k0s-configuration.md",sourceDirName:"getting-started",slug:"/getting-started/k0s-configuration",permalink:"/docs/getting-started/k0s-configuration",draft:!1,editUrl:"https://github.com/SquareFactory/ClusterFactory-CE/tree/main/web/docs/getting-started/03-k0s-configuration.md",tags:[],version:"current",sidebarPosition:3,frontMatter:{},sidebar:"docs",previous:{title:"2. Setting up your repository for GitOps",permalink:"/docs/getting-started/setting-up-repository"},next:{title:"4. Core Apps Deployment",permalink:"/docs/getting-started/core-apps-deployment"}},u={},p=[{value:"Specifying the hosts",id:"specifying-the-hosts",level:2},{value:"Configuring the k0s architecture",id:"configuring-the-k0s-architecture",level:2},{value:"Configuring Traefik",id:"configuring-traefik",level:2},{value:"Initial Deployment",id:"initial-deployment",level:2}],d={toc:p};function f(e){var t=e.components,n=(0,o.Z)(e,i);return(0,a.kt)("wrapper",(0,r.Z)({},d,n,{components:t,mdxType:"MDXLayout"}),(0,a.kt)("h1",{id:"3-k0s-configuration"},"3. K0s Configuration"),(0,a.kt)("h2",{id:"specifying-the-hosts"},"Specifying the hosts"),(0,a.kt)("p",null,"Edit the ",(0,a.kt)("inlineCode",{parentName:"p"},"cfctl.yaml")," file. Start with the ",(0,a.kt)("inlineCode",{parentName:"p"},"hosts")," field :"),(0,a.kt)("pre",null,(0,a.kt)("code",{parentName:"pre",className:"language-yaml",metastring:"title=cfctl.yaml",title:"cfctl.yaml"},'apiVersion: cfctl.clusterfactory.io/v1beta1\nkind: Cluster\nmetadata:\n  name: k8s.example.com-cluster\nspec:\n  hosts:\n    - ssh:\n        address: 192.168.0.2\n        user: root\n        port: 22\n        keyPath: ~/.ssh/id_ed25519\n      role: controller+worker\n      noTaints: true\n      privateInterface: eno1\n      privateAddress: 192.168.0.2\n      installFlags:\n        - --debug\n        - --labels="topology.kubernetes.io/region=ch-sion,topology.kubernetes.io/zone=ch-sion-1"\n        - --disable-components coredns\n      hooks:\n        apply:\n          before:\n            # Set SELinux Permissive\n            - sh -c \'if [ "$(getenforce)" != "Permissive" ] && [ "$(getenforce)" != "Disabled" ]; then sed -i s/^SELINUX=.*$/SELINUX=permissive/ /etc/selinux/config; fi\'\n            - sh -c \'if [ "$(getenforce)" != "Permissive" ] && [ "$(getenforce)" != "Disabled" ]; then setenforce 0; fi\'\n\n  ...\n')),(0,a.kt)("p",null,"Provide each host with a valid IP address that is reachable by k0ctl, and the connection details for an SSH connection. Edit the labels for multi-zone usage."),(0,a.kt)("p",null,(0,a.kt)("a",{parentName:"p",href:"/docs/reference/cfctl.yaml"},"See ",(0,a.kt)("inlineCode",{parentName:"a"},"cfctl.yaml")," specification"),"."),(0,a.kt)("h2",{id:"configuring-the-k0s-architecture"},"Configuring the k0s architecture"),(0,a.kt)("p",null,"After you set the ",(0,a.kt)("inlineCode",{parentName:"p"},"hosts")," field, you must configure the k0s architecture by editing the ",(0,a.kt)("inlineCode",{parentName:"p"},"k0s")," field:"),(0,a.kt)("pre",null,(0,a.kt)("code",{parentName:"pre",className:"language-yaml",metastring:'title="cfctl.yaml > spec > k0s"',title:'"cfctl.yaml',">":!0,spec:!0,'k0s"':!0},"k0s:\n  version: '1.24.3+k0s.0'\n  dynamicConfig: false\n  config:\n    apiVersion: k0s.k0sproject.io/v1beta1\n    kind: Cluster\n    metadata:\n      name: k8s.example.com\n    spec:\n      api:\n        k0sApiPort: 9443\n        port: 6443\n      installConfig:\n        users:\n          etcdUser: etcd\n          kineUser: kube-apiserver\n          konnectivityUser: konnectivity-server\n          kubeAPIserverUser: kube-apiserver\n          kubeSchedulerUser: kube-scheduler\n      konnectivity:\n        adminPort: 8133\n        agentPort: 8132\n      network:\n        calico:\n          mode: 'vxlan'\n          overlay: Always\n          mtu: 0\n          wireguard: false\n        kubeProxy:\n          disabled: false\n          mode: iptables\n        kuberouter:\n          autoMTU: true\n          mtu: 0\n          peerRouterASNs: ''\n          peerRouterIPs: ''\n        podCIDR: 10.244.0.0/16\n        provider: calico\n        serviceCIDR: 10.96.0.0/12\n      podSecurityPolicy:\n        defaultPolicy: 00-k0s-privileged\n      storage:\n        type: etcd\n      telemetry:\n        enabled: false\n")),(0,a.kt)("p",null,"Check the CIDR and make sure it doesn't conflict with any IP range of your network."),(0,a.kt)("p",null,"Again, ",(0,a.kt)("strong",{parentName:"p"},"you should read the specification carefully as the modification of one the k0s field won't be allowed in the future"),"."),(0,a.kt)("p",null,"If you wish to use a HA setup, please follow ",(0,a.kt)("a",{parentName:"p",href:"/docs/guides/maintenance/high-availability"},"this guide"),"."),(0,a.kt)("p",null,"After setting up k0s, you can change the ",(0,a.kt)("inlineCode",{parentName:"p"},"extensions")," field. This field can be changed at any time. You can add or change extensions. However, removing an extension is permanent."),(0,a.kt)("h2",{id:"configuring-traefik"},"Configuring Traefik"),(0,a.kt)("p",null,"You should configure Traefik, which is the main Ingress and L7 load balancer."),(0,a.kt)("pre",null,(0,a.kt)("code",{parentName:"pre",className:"language-yaml",metastring:'title="cfctl.yaml > spec > k0s > spec > extensions > helm > charts[]"',title:'"cfctl.yaml',">":!0,spec:!0,k0s:!0,extensions:!0,helm:!0,'charts[]"':!0},"- name: traefik\n  chartname: traefik/traefik\n  version: '10.24.0'\n  namespace: traefik\n  values: |\n\n    ingressClass:\n      enabled: true\n      isDefaultClass: true\n\n    service:\n      enabled: true\n      annotations:\n        metallb.universe.tf/address-pool: main-pool\n        metallb.universe.tf/allow-shared-ip: traefik-lb-key\n      spec:\n        externalTrafficPolicy: Cluster\n        loadBalancerIP: 192.168.1.100\n\n    providers:\n      kubernetesCRD:\n        enabled: true\n        allowCrossNamespace: true\n        allowExternalNameServices: true\n        namespaces: []\n      kubernetesIngress:\n        enabled: true\n        allowExternalNameServices: true\n        namespaces: []\n        ingressClass: traefik\n        publishedService:\n          enabled: true\n\n    globalArguments:\n      - '--global.checknewversion'\n      - '--api.dashboard=true'\n\n    additionalArguments:\n      - '--entryPoints.websecure.proxyProtocol.insecure'\n      - '--entryPoints.websecure.forwardedHeaders.insecure'\n\n    ingressRoute:\n      dashboard:\n        enabled: false\n\n    ports:\n      traefik:\n        port: 9000\n        expose: false\n        exposedPort: 9000\n        protocol: TCP\n      dns-tcp:\n        port: 8053\n        expose: true\n        exposedPort: 53\n        protocol: TCP\n      dns-udp:\n        port: 8054\n        expose: true\n        exposedPort: 53\n        protocol: UDP\n      web:\n        port: 80\n        expose: true\n        exposedPort: 80\n        protocol: TCP\n      websecure:\n        port: 443\n        expose: true\n        exposedPort: 443\n        protocol: TCP\n        # You MUST open port 443 UDP!\n        # HTTP3 upgrades the connection from TCP to UDP.\n        http3: true\n        tls:\n          enabled: true\n      metrics:\n        port: 9100\n        expose: false\n        exposedPort: 9100\n        protocol: TCP\n\n    experimental:\n      http3:\n        enabled: true\n\n    securityContext:\n      capabilities:\n        drop: [ALL]\n        add: [NET_BIND_SERVICE]\n      readOnlyRootFilesystem: true\n      runAsGroup: 0\n      runAsNonRoot: false\n      runAsUser: 0\n\n    podSecurityContext:\n      fsGroup: 65532\n")),(0,a.kt)("p",null,"Since we are using MetalLB, we select our ",(0,a.kt)("inlineCode",{parentName:"p"},"IPAddressPool")," by using the ",(0,a.kt)("inlineCode",{parentName:"p"},"metallb.universe.tf/address-pool")," annotation. In, the next chapter will deploy the ",(0,a.kt)("inlineCode",{parentName:"p"},"IPAddressPool"),". For now, let's assume we only need one ",(0,a.kt)("inlineCode",{parentName:"p"},"IPAddressPool")," which is ",(0,a.kt)("inlineCode",{parentName:"p"},"main-pool"),"."),(0,a.kt)("p",null,"Look for ",(0,a.kt)("inlineCode",{parentName:"p"},"loadBalancerIP"),", the value of that field we correspond to a IP address included in the ",(0,a.kt)("inlineCode",{parentName:"p"},"IPAddressPool"),". ",(0,a.kt)("strong",{parentName:"p"},"This IP address will be exposed to the external network.")),(0,a.kt)("p",null,"After that, you can add or remove ports. Since Traefik will be used as the main Ingress, these ports will be exposed to the external network."),(0,a.kt)("p",null,"The IngressClass is ",(0,a.kt)("inlineCode",{parentName:"p"},"traefik"),". If you don't want to use Traefik as the main Ingress, feel free to add an another extension."),(0,a.kt)("p",null,"We use Traefik because it can do a lot of complex route operations while still being able to do basic HTTP routing."),(0,a.kt)("h2",{id:"initial-deployment"},"Initial Deployment"),(0,a.kt)("p",null,"If you forgot to install the utilities, just run:"),(0,a.kt)("pre",null,(0,a.kt)("code",{parentName:"pre",className:"language-shell",metastring:'title="user@local:/ClusterFactory-CE"',title:'"user@local:/ClusterFactory-CE"'},". ./scripts/setup-env\n")),(0,a.kt)("p",null,"Deploy the cluster with:"),(0,a.kt)("pre",null,(0,a.kt)("code",{parentName:"pre",className:"language-shell",metastring:'title="user@local:/ClusterFactory-CE"',title:'"user@local:/ClusterFactory-CE"'},"# Deploy the cluster\ncfctl apply --debug --config ./cfctl.yaml\n\n# Fetch the kubeconfig\ncfctl kubeconfig --config ./cfctl.yaml >./kubeconfig\nchmod 600 ./kubeconfig\n")),(0,a.kt)("p",null,"You can store the kubeconfig inside ",(0,a.kt)("inlineCode",{parentName:"p"},"~/.kube/config"),". Our recommendation is to set the ",(0,a.kt)("inlineCode",{parentName:"p"},"KUBECONFIG")," environment variable to avoid mixing the Kubernetes contexts. Just like this:"),(0,a.kt)("pre",null,(0,a.kt)("code",{parentName:"pre",className:"language-shell",metastring:'title="user@local:/ClusterFactory-CE"',title:'"user@local:/ClusterFactory-CE"'},"cfctl kubeconfig --config ./cfctl.yaml >./kubeconfig\nchmod 600 ./kubeconfig\n`export KUBECONFIG=$(pwd)/kubeconfig`.\n")),(0,a.kt)("p",null,"Just make sure to verify which configuration you are using with ",(0,a.kt)("inlineCode",{parentName:"p"},"kubectl config current-context"),". You can add an alias to your favorite shell:"),(0,a.kt)("pre",null,(0,a.kt)("code",{parentName:"pre",className:"language-shell"},'alias kubectx="kubectl config current-context"\n')),(0,a.kt)("p",null,"Congratulation, you have deployed your Kubernetes cluster! However, it's still missing a few core features:"),(0,a.kt)("ul",null,(0,a.kt)("li",{parentName:"ul"},"MetalLB advertisements, for Load Balancing"),(0,a.kt)("li",{parentName:"ul"},"CoreDNS, which is the internal DNS for Kubernetes"),(0,a.kt)("li",{parentName:"ul"},"KubeVirt, to deploy VM workloads"),(0,a.kt)("li",{parentName:"ul"},"Multus CNI, to support multiple network interfaces"),(0,a.kt)("li",{parentName:"ul"},"Sealed Secrets, secret management optimized for GitOps"),(0,a.kt)("li",{parentName:"ul"},"Cert-manager issuers, to generate your SSL certificates and enable, for free, TLS configuration."),(0,a.kt)("li",{parentName:"ul"},"Argo CD, to enable GitOps.")))}f.isMDXComponent=!0}}]);